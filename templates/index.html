<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test Request Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h2 class="text-center">Submit a Test Request</h2>
        <form id="testRequestForm" class="p-4 bg-white shadow rounded">
            <div class="mb-3">
                <label for="deadline" class="form-label">Deadline:</label>
                <input type="date" name="deadline" id="deadline" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="notes" class="form-label">Notes:</label>
                <textarea name="notes" id="notes" class="form-control" rows="3"></textarea>
            </div>
            <hr>
            <h4>Test Instances</h4>
            <div id="testInstances"></div>
            <button type="button" class="btn btn-secondary mt-3" onclick="addTestInstance()">Add Test Instance</button>
            <button type="submit" class="btn btn-primary w-100 mt-3">Submit Request</button>
        </form>
    </div>

    <script>
        function addTestInstance() {
            let instanceId = Date.now();
            let testInstanceHTML = `
                <div class="border p-3 mt-3 bg-light rounded" id="instance-${instanceId}">
                    <h5>Test Instance</h5>
                    <label class="form-label">Test Type:</label>
                    <select class="form-select" name="test_type[]">
                        <option value="Images">Images</option>
                        <option value="Transmission">Transmission</option>
                        <option value="Switching Speed">Switching Speed</option>
                    </select>
                    <label class="form-label mt-2">Voltage (V):</label>
                    <input type="number" name="voltage[]" class="form-control">
                    <label class="form-label mt-2">Polarisers:</label>
                    <input type="text" name="polarisers[]" class="form-control">
                    <label class="form-label mt-2">Cell Orientation:</label>
                    <input type="text" name="cell_orientation[]" class="form-control">
                    <label class="form-label mt-2">Polariser Number:</label>
                    <input type="number" name="polariser_number[]" class="form-control">
                    <label class="form-label mt-2">State of Cell:</label>
                    <select class="form-select" name="state_of_cell[]">
                        <option value="ON">ON</option>
                        <option value="OFF">OFF</option>
                    </select>
                    <label class="form-label mt-2">Tool:</label>
                    <input type="text" name="tool[]" class="form-control">
                    <button type="button" class="btn btn-danger mt-2" onclick="removeTestInstance(${instanceId})">Remove</button>
                </div>
            `;
            $('#testInstances').append(testInstanceHTML);
        }

        function removeTestInstance(id) {
            $(`#instance-${id}`).remove();
        }

        $('#testRequestForm').submit(function(event) {
            event.preventDefault();
            let testInstances = [];

            $('#testInstances .border').each(function() {
                let instance = {
                    test_type: $(this).find('[name="test_type[]"]').val(),
                    voltage: $(this).find('[name="voltage[]"]').val(),
                    polarisers: $(this).find('[name="polarisers[]"]').val(),
                    cell_orientation: $(this).find('[name="cell_orientation[]"]').val(),
                    polariser_number: $(this).find('[name="polariser_number[]"]').val(),
                    state_of_cell: $(this).find('[name="state_of_cell[]"]').val(),
                    tool: $(this).find('[name="tool[]"]').val()
                };
                testInstances.push(instance);
            });

            let requestData = {
                deadline: $('#deadline').val(),
                notes: $('#notes').val(),
                test_instances: testInstances
            };

            $.ajax({
                url: '/submit',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function(response) {
                    alert(response.message);
                    location.reload();
                },
                error: function(response) {
                    alert('Error submitting request');
                }
            });
        });
    </script>
</body>
</html>
